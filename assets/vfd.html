<html>
    <head>
        <title>VFD Display System</title>
        <script type="text/javascript" src="api/api-ws.js"></script> 
        <script type="text/javascript" src="api/api.js"></script>
        <script type="text/javascript" src="vfd.js"></script>
        <script type="text/javascript">
			var oldBpm = 0;
			var queue = [];
            var current = undefined;

			var stingers = {
				'D:\\Music\\_Collection\\!Music\\!JAP\\!JCore\\Under Planet\\09. Fang - Palpitation.mp3': [
					{timestamp: 65.0, exe: () => EFF.run(new DispEffectJustShow({top: "I'm alright", bottom: "Do you mind?"}, 25))},
					{timestamp: 75.0, exe: () => dispNowp()}
				]
			};
            
			function dispNowp() {
				EFF.run(new DispEffectResetAndCursor({x: 1, y: 2, show: true}));
				EFF.run(new DispEffectWipeUp(50, " ", "by " + current.artist.substring(0,20)));
				EFF.run(new DispEffectSlideInRight({top: "    -= " + current.title + " =-     ", topScrolls: true}, 10));
			}

            function dispNext() {
				// If nothing more to show, return
				if(queue.length == 0)  {
					EFF.run(new DispEffectWipeDown());
					current = undefined;
					return;
				}

				current = queue.shift();
				
				EFF.run(new DispEffectWipeUp());
				EFF.run(new DispEffectSlideInRight({top: "DJ /akasaka in", bottom:"       Anison Hijack"}, 50));
				EFF.run(new DispEffectPause(2000));
				EFF.run(new DispEffectWipeDown());
				EFF.run(new DispEffectResetAndCursor({x: 1, y: 2, show: true}));
				EFF.run(new DispEffectTyping("Now playing..."));
				EFF.run(new DispEffectPause(1000));
				dispNowp();
			}
            
            // Called when track ends playing
            function popTrack(meta) {
                console.log("Pop track:", meta);
                
                if(current && current.filePath == meta.filePath) {
                   dispNext();
                } else {
                   queue = queue.filter(item => item.filePath != meta.filePath);
                }
            }

            // Called when new track plays
            function pushTrack(meta) {
                console.log("Push track:", meta);
                queue.push(meta);
                if(!current) dispNext();
            }

            // Called when bpm changes
            function onBpmChanged(bpm) {
				return; //disable
				if(bpm == oldBpm) return;
				if(oldBpm == 0) {
					oldBpm = bpm;
					return;
				}
				
                console.log("Change bpm to", bpm);
                
                var promise = undefined;
                
                if(bpm > oldBpm) {
					let topLine = "    Speeding up!    ";
					let bottomLine = ("New BPM: "+bpm.toString()).padStart(20);
					promise = EFF.run(new DispEffectWipeUp(25, topLine, bottomLine));
				}
				else if(bpm < oldBpm) {
					let topLine = "   Chilling down!   ";
					let bottomLine = ("New BPM: "+bpm.toString()).padStart(20);
					promise = EFF.run(new DispEffectWipeDown(25, topLine, bottomLine));
				}
               
                var pause = new DispEffectPause(1000); 
                if(current) {
					var meta = new DispEffectSlideInRight({top: current.title, topScrolls: true, bottom: current.artist}, 50);
					promise.next(pause).next(meta);
				} else {
					promise.next(pause).next(new DispEffectResetAndCursor({x: 1, y: 1, show: false}))
				}
                
                oldBpm = bpm;
            }

            function trackTick(meta) {
				if(meta.filePath != current.filePath) return;

				if(stingers[meta.filePath]) {
					let songStinger = stingers[meta.filePath]
							.filter(x=> Math.abs(x.timestamp - meta.elapsedTime) <= 0.5)[0];
					if(songStinger && !songStinger.bonk) {
						songStinger.exe();
					}
				}
            }
            
            function startPort() {
				DISPLAY.init();
				document.getElementById('startBtn').style.display = "none";
				document.getElementById('hint').style.display = "none";
			}
        </script>
    </head>
    <body>
		<p id="hint">Connect CD7220 compatible VFD pole display to a serial port and click:</p>
		<button onclick="startPort()" id="startBtn">Connect</button>
    </body>
</html>
